@startuml
left to right direction
skinparam classAttributeIconSize 0

' Entity
class User {
    -id: String
    -username: String
    -password: String
    -email: String
    -createdAt: Instant
    -goals: Goals
    -role: String
    -meals: List<Meal>
    -storages: List<Storage>
}

class Storage {
    -id: String
    -userId: String
    -name: String
    -totalWeight: double
    -consumedWeight: double
    -weightPerMeal: double
    -nutritionPer100g: Nutrition
    -lowStockThreshold: double
    -createdAt: Instant
    -updatedAt: Instant
    -lowStock: boolean
    +getRemainingWeight(): double
    +getMealsLeft(): double
    +isLowStock(): boolean
    +getProgressPercentage(): double
}

record Nutrition {
    +protein: double
    +carbs: double
    +fat: double
    +kcal: double
    +scale(weightInGrams: double): Nutrition
    -round(value: double): double
}

class Meal {
    -id: String
    -userId: String
    -storageId: String
    -name: String
    -weight: double
    -nutrition: Nutrition
    -consumedAt: Instant
    +isFromStorage(): boolean
}

record Goals {
    +targetProtein: double
    +targetCarbs: double
    +targetFat: double
    +targetCalories: double
}

' Repositories
interface JpaRepository<T, ID>

interface UserRepository {
    +findByUsername(username: String): Optional<User>
    +findByEmail(email: String): Optional<User>
    +existsByUsername(username: String): boolean
    +existsByEmail(email: String): boolean
}

interface StorageRepository {
    +findByUserId(userId: String): Collection<Storage>
    +findByIdAndUserId(id: String, userId: String): Optional<Storage>
    +countByUserId(userId: String): long
}

interface MealRepository {
    +findByUserIdAndConsumedAtBetween(userId: String, from: Instant, to: Instant): Collection<Meal>
    +findByStorageId(storageId: String): Collection<Meal>
    +findByUserIdAndStorageIdIsNull(userId: String): Collection<Meal>
    +countByUserIdAndConsumedAtBetween(userId: String, from: Instant, to: Instant): long
    +findByUserIdAndStorageIdAndConsumedAtAfter(userId: String, storageId: String, date: Instant): List<Meal>
}

' Services
interface UserService {
    +createUser(name: String, email: String, password: String): User
    +findByUsername(username: String): User
    +verifyPassword(password: String, hashedPassword: String): boolean
    +usernameExists(username: String): boolean
    +emailExists(email: String): boolean
    +deleteUser(userId: String): void
    +findById(userId: String): User
    +updateGoals(userId: String, goals: Goals): Goals
}

class UserServiceImpl {
    -userRepository: UserRepository
    -passwordEncoder: PasswordEncoder
    +createUser(name: String, email: String, password: String): User
    +findByUsername(username: String): User
    +verifyPassword(password: String, hashedPassword: String): boolean
    +usernameExists(username: String): boolean
    +emailExists(email: String): boolean
    +deleteUser(userId: String): void
    +findById(userId: String): User
    +updateGoals(userId: String, goals: Goals): Goals
}

interface StorageService {
    +registerStorage(userId: String, storage: Storage): Storage
    +getNutrition(storageId: String, userId: String): Nutrition
    +deleteStorage(userId: String, storageId: String): void
    +getStorage(userId: String): Collection<Storage>
    +getStorageById(userId: String, storageId: String): Storage
    +updateStorage(userId: String, storage: Storage): Storage
    +updateConsumedWeight(userId: String, storageId: String, weightChange: double): Storage
}

class StorageServiceImpl {
    -storageRepository: StorageRepository
    -mealService: MealService
    +registerStorage(userId: String, storage: Storage): Storage
    +getNutrition(storageId: String, userId: String): Nutrition
    +deleteStorage(userId: String, storageId: String): void
    +getStorage(userId: String): Collection<Storage>
    +getStorageById(userId: String, storageId: String): Storage
    +updateStorage(userId: String, storage: Storage): Storage
    +updateConsumedWeight(userId: String, storageId: String, weightChange: double): Storage
}

interface MealService {
    +registerMeal(userId: String, meal: Meal): Meal
    +getMealsForUserBetween(userId: String, from: Instant, to: Instant): Collection<Meal>
    +getDailyNutrition(userId: String, from: Instant, to: Instant): Nutrition
    +deleteMeal(userId: String, mealId: String): void
    +updateMeal(userId: String, meal: Meal): Meal
    +findMealsByUserAndStorageSince(userId: String, storageId: String, from: Instant): List<Meal>
}

class MealServiceImpl {
    -mealRepository: MealRepository
    -storageService: StorageService
    +registerMeal(userId: String, meal: Meal): Meal
    +getMealsForUserBetween(userId: String, from: Instant, to: Instant): Collection<Meal>
    +getDailyNutrition(userId: String, from: Instant, to: Instant): Nutrition
    +deleteMeal(userId: String, mealId: String): void
    +updateMeal(userId: String, meal: Meal): Meal
    +findMealsByUserAndStorageSince(userId: String, storageId: String, from: Instant): List<Meal>
}

interface AuthService {
    +register(request: RegisterRequest): AuthResponse
    +login(request: LoginRequest): AuthResponse
    +deleteUser(userId: String): void
    +refreshToken(refreshToken: String): AuthResponse
}

class AuthServiceImpl {
    -userService: UserService
    -jwtUtil: JwtUtil
    +register(request: RegisterRequest): AuthResponse
    +login(request: LoginRequest): AuthResponse
    -generateAuthResponse(user: User): AuthResponse
    +deleteUser(userId: String): void
    +refreshToken(refreshToken: String): AuthResponse
    -generateAuthResponse(user: User): AuthResponse
}

' DTOs - Request
class LoginRequest {
    -username: String
    -password: String
}

class RefreshRequest {
    -refreshToken: String
}

class RegisterRequest {
    -username: String
    -password: String
    -email: String
    -goals: Goals
}

class CreateStorageRequest {
    -name: String
    -nutritionPer100g: Nutrition
    -totalWeight: double
    -weightPerMeal: double
    -lowStockThreshold: double
    -createdAt: Instant
}

class UpdateStorageRequest {
    -name: String
    -totalWeight: double
    -nutritionPer100g: Nutrition
    -weightPerMeal: double
    -lowStockThreshold: double
    -createdAt: Instant
}

class CreateMealRequest {
    -name: String
    -weight: double
    -nutrition: Nutrition
    -storageId: String
    -consumedAt: Instant
}

class UpdateMealRequest {
    -name: String
    -weight: double
    -nutrition: Nutrition
    -consumedAt: Instant
    -storageId: String
}

class UpdateUserGoalsRequest {
    -targetProtein: double
    -targetCarbs: double
    -targetFat: double
    -targetCalories: double
}


' DTOs - Response
class AuthResponse {
    -accessToken: String
    -refreshToken: String
    -message: String
}

class MessageResponse {
    -message: String
}

class StorageResponse {
    -id: String
    -name: String
    -totalWeight: double
    -consumedWeight: double
    -weightPerMeal: double
    -nutritionPer100g: Nutrition
    -lowStockThreshold: double
    -createdAt: Instant
    -updatedAt: Instant
    -mealsLeft: double
    -mealsLeftPercentage: double
    -lowStock: boolean
}

class MealResponse {
    -id: String
    -name: String
    -weight: double
    -consumedAt: Instant
    -nutrition: Nutrition
    -storageId: String
}

class UserGoalsResponse {
    -targetProtein: double
    -targetCarbs: double
    -targetFat: double
    -targetCalories: double
}

class UserResponse {
    -username: String
    -email: String
    -goals: Goals
}

' Controllers
class AuthenticationController {
    -authService: AuthService
    -jwtProperties: JwtProperties
    -cookiesSecure: boolean
    +register(request: RegisterRequest): ResponseEntity<MessageResponse>
    +login(request: LoginRequest): ResponseEntity<MessageResponse>
    +deleteUser(user: AuthenticatedUser): ResponseEntity<Void>
    +logout(): ResponseEntity<MessageResponse>
    +refreshToken(refreshToken: String): ResponseEntity<MessageResponse>
    -buildCookieHeaders(accessToken: String, refreshToken: String): HttpHeaders
    -buildCookie(name: String, value: String, maxAgeSeconds: long): ResponseCookie
}

class StorageController {
    -storageService: StorageService
    +addStorage(user: AuthenticatedUser, request: CreateStorageRequest): ResponseEntity<StorageResponse>
    +deleteStorage(user: AuthenticatedUser, storageId: String): ResponseEntity<Void>
    +getStorage(user: AuthenticatedUser): ResponseEntity<List<StorageResponse>>
    +updateStorage(user: AuthenticatedUser, storageId: String, request: UpdateStorageRequest): ResponseEntity<StorageResponse>
}

class MealsController {
    -mealService: MealService
    +addMeal(user: AuthenticatedUser, request: CreateMealRequest): ResponseEntity<MealResponse>
    +deleteMeal(user: AuthenticatedUser, mealId: String): ResponseEntity<Void>
    +getMeals(user: AuthenticatedUser, date: LocalDate): ResponseEntity<List<MealResponse>>
    +updateMeal(user: AuthenticatedUser, mealId: String, request: UpdateMealRequest): ResponseEntity<MealResponse>
    +getDailyNutritionSummary(user: AuthenticatedUser, date: LocalDate): ResponseEntity<Nutrition>
}

class UserController {
    -userService: UserService
    +getUser(user: AuthenticatedUser): ResponseEntity<UserResponse>
    +updateUser(user: AuthenticatedUser, request: UpdateUserRequest): ResponseEntity<UserResponse>
    +updateGoals(user: AuthenticatedUser, request: UpdateUserGoalsRequest): ResponseEntity<UserGoalsResponse>
    +updatePassword(user: AuthenticatedUser, request: UpdateUserRequest): ResponseEntity<UserResponse>
    +deleteUser(user: AuthenticatedUser): ResponseEntity<Void>
}

' Mappers
class MealMapper {
    +{static} toEntity(request: CreateMealRequest): Meal
    +{static} toEntity(mealId: String, request: UpdateMealRequest): Meal
    +{static} toResponse(meal: Meal): MealResponse
}

class StorageMapper {
   +{static} toEntity(request: CreateStorageRequest): Storage
   +{static} toEntity(storageId: String, request: UpdateStorageRequest): Storage
   +{static} toResponse(storage: Storage): StorageResponse
}

class UserMapper {
    +{static} toResponse(user: User): UserResponse
    +{static} toGoalsEntity(request: UpdateUserGoalsRequest): Goals
    +{static} toGoalsResponse(goals: Goals): UserGoalsResponse
}

' Config
class JwtProperties {
    -secret: String
    -expiration: long
    -refreshExpiration: long
}

interface PasswordEncoder

'Utilities
class JwtUtil {
    -jwtProperties: JwtProperties
    -getSigningKey(): SecretKey
    +generateToken(userId: String): String
    +generateRefreshToken(userId: String): String
    +extractUserId(token: String): String
    +validateToken(token: String): boolean
}

' Implementation Relationships
UserServiceImpl ..|> UserService
StorageServiceImpl ..|> StorageService
MealServiceImpl ..|> MealService
AuthServiceImpl ..|> AuthService

' Extends Relationships
UserRepository -|> JpaRepository
StorageRepository -|> JpaRepository
MealRepository -|> JpaRepository

' Entity Relationships
User "1" *-- "1" Goals : contains
Meal "1" *-- "1" Nutrition : contains
Storage "1" *-- "1" Nutrition : contains

' Controller Dependencies
AuthenticationController --> AuthService
StorageController --> StorageService
MealsController --> MealService

StorageController --> StorageMapper
MealsController --> MealMapper
UserController --> UserMapper

AuthenticationController ..> RegisterRequest
AuthenticationController ..> LoginRequest
AuthenticationController ..> RefreshRequest
AuthenticationController ..> MessageResponse
AuthenticationController ..> AuthResponse
AuthenticationController --> JwtProperties

StorageController ..> CreateStorageRequest
StorageController ..> UpdateStorageRequest
StorageController ..> StorageResponse

MealsController ..> CreateMealRequest
MealsController ..> UpdateMealRequest
MealsController ..> MealResponse

UserController --> UserService
UserController ..> UpdateUserRequest
UserController ..> UpdateUserGoalsRequest
UserController ..> UserGoalsResponse
UserController ..> UserResponse

' Mapper Transformations
MealMapper ..> CreateMealRequest : reads
MealMapper ..> Meal : creates
MealMapper ..> MealResponse : creates

StorageMapper ..> CreateStorageRequest : reads
StorageMapper ..> Storage : creates
StorageMapper ..> StorageResponse : creates

UserMapper ..> User : reads
UserMapper ..> UserResponse : creates
UserMapper ..> UpdateUserGoalsRequest : reads
UserMapper ..> Goals : creates
UserMapper ..> UserGoalsResponse : creates

' Service Dependencies
UserServiceImpl --> UserRepository
StorageServiceImpl --> StorageRepository
MealServiceImpl --> MealRepository
AuthServiceImpl --> JwtUtil
UserServiceImpl --> PasswordEncoder
JwtUtil --> JwtProperties
StorageServiceImpl --> MealService

' Service to service calls
MealServiceImpl --> StorageService : updates consumed weight
AuthServiceImpl --> UserService : manages users

@enduml